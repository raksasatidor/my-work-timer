<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Time Calculator</title>
    <link rel="stylesheet" href="style.css">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            // --- STATE MANAGEMENT ---
            const [timeIn, setTimeIn] = useState("08:30");
            const [timeOut, setTimeOut] = useState("");
            const [otTable, setOtTable] = useState([]);
            const [isOutOfRange, setIsOutOfRange] = useState(false);
            const [theme, setTheme] = useState('light');
            
            // Live Date State
            const [currentDate, setCurrentDate] = useState(new Date());

            // Weather States
            const [weatherData, setWeatherData] = useState(null);
            const [weatherLoading, setWeatherLoading] = useState(true);

            // Prayer Time States
            const [prayerTimes, setPrayerTimes] = useState([]);
            const [nextPrayer, setNextPrayer] = useState(null);

            // --- SETUP & INIT ---
            useEffect(() => {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = prefersDark ? 'dark' : 'light';
                setTheme(initialTheme);
                document.documentElement.setAttribute('data-theme', initialTheme);
                
                fetchWeather();
                fetchPrayerTimes();

                // Timer for Live Date (Updates every second)
                const timer = setInterval(() => {
                    setCurrentDate(new Date());
                }, 1000);

                // Cleanup timer on unmount
                return () => clearInterval(timer);
            }, []);

            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                document.documentElement.setAttribute('data-theme', newTheme);
            };

            // --- DATE FORMATTER ---
            const formatDate = (date) => {
                return date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            };

            // --- WEATHER LOGIC (Sony Bangi) ---
            const fetchWeather = async () => {
                try {
                    const response = await fetch(
                        "https://api.open-meteo.com/v1/forecast?latitude=2.937019&longitude=101.760007&current_weather=true"
                    );
                    const data = await response.json();
                    setWeatherData(data.current_weather);
                    setWeatherLoading(false);
                } catch (error) {
                    console.error("Failed to fetch weather", error);
                    setWeatherLoading(false);
                }
            };

            const getWeatherMessage = (code) => {
                if (code === undefined) return { icon: "‚ùì", title: "Checking Sony...", msg: "Looking outside..." };
                if (code >= 95) return { icon: "‚õàÔ∏è", title: "Stormy at Sony", msg: "Dangerously stormy! Stay inside, you're electric enough without the lightning. ‚ö°" };
                else if (code >= 51) return { icon: "‚òî", title: "Raining at Sony", msg: "Don't forget your umbrella! It's crying outside, but your outfit is still fire. üî•" };
                else return { icon: "‚òÄÔ∏è", title: "Sunny at Sony", msg: "No umbrella needed! The weather is bright, just like your beautiful face today. ‚ú®" };
            };

            // --- PRAYER TIME LOGIC (SGR01) ---
            const fetchPrayerTimes = async () => {
                try {
                    const res = await fetch("https://api.waktusolat.app/v2/solat/SGR01");
                    const data = await res.json();
                    const today = new Date();
                    const day = today.getDate();
                    const todayPrayers = data.prayers[day - 1]; 

                    if (todayPrayers) {
                        const formatTime = (timestamp) => {
                            const date = new Date(timestamp * 1000);
                            let hours = date.getHours();
                            let minutes = date.getMinutes();
                            const ampm = hours >= 12 ? 'PM' : 'AM';
                            hours = hours % 12;
                            hours = hours ? hours : 12;
                            minutes = minutes < 10 ? '0' + minutes : minutes;
                            return `${hours}:${minutes} ${ampm}`;
                        };
                        
                        const list = [
                            { name: 'Subuh', time: formatTime(todayPrayers.fajr), raw: todayPrayers.fajr },
                            { name: 'Zohor', time: formatTime(todayPrayers.dhuhr), raw: todayPrayers.dhuhr },
                            { name: 'Asar', time: formatTime(todayPrayers.asr), raw: todayPrayers.asr },
                            { name: 'Maghrib', time: formatTime(todayPrayers.maghrib), raw: todayPrayers.maghrib },
                            { name: 'Isyak', time: formatTime(todayPrayers.isha), raw: todayPrayers.isha }
                        ];
                        setPrayerTimes(list);
                        determineNextPrayer(list);
                    }
                } catch (error) {
                    console.error("Failed to fetch prayer times", error);
                }
            };

            const determineNextPrayer = (prayers) => {
                const now = Math.floor(Date.now() / 1000);
                const next = prayers.find(p => p.raw > now);
                if (next) setNextPrayer(next.name);
                else setNextPrayer(null); 
            };

            // --- TIME CALCULATION LOGIC ---
            const addTime = (baseTime, hoursToAdd, minutesToAdd) => {
                if (!baseTime) return "";
                const [h, m] = baseTime.split(':').map(Number);
                const date = new Date();
                date.setHours(h);
                date.setMinutes(m);
                date.setHours(date.getHours() + hoursToAdd);
                date.setMinutes(date.getMinutes() + minutesToAdd);
                const newH = String(date.getHours()).padStart(2, '0');
                const newM = String(date.getMinutes()).padStart(2, '0');
                return `${newH}:${newM}`;
            };

            useEffect(() => {
                if (timeIn) {
                    if (timeIn < "07:30" || timeIn > "09:30") {
                        setIsOutOfRange(true);
                    } else {
                        setIsOutOfRange(false);
                    }
                    const standardExit = addTime(timeIn, 9, 30);
                    setTimeOut(standardExit);
                    const ot1 = addTime(standardExit, 1, 10);
                    const ot2 = addTime(ot1, 1, 0);
                    const ot3 = addTime(ot2, 1, 0);
                    const ot4 = addTime(ot3, 1, 0);
                    setOtTable([
                        { label: "1 Hour OT", time: ot1 },
                        { label: "2 Hours OT", time: ot2 },
                        { label: "3 Hours OT", time: ot3 },
                        { label: "4 Hours OT", time: ot4 },
                    ]);
                }
            }, [timeIn]);

            const weatherInfo = getWeatherMessage(weatherData?.weathercode);

            return (
                <div className="container">
                    <button className="theme-toggle" onClick={toggleTheme} title="Toggle Theme">
                        {theme === 'light' ? 'üåô' : '‚òÄÔ∏è'}
                    </button>

                    <h1>Go Home Calculator</h1>
                    
                    <div className="live-date">{formatDate(currentDate)}</div>

                    <div className="input-group">
                        <label>Time In</label>
                        <input 
                            type="time" 
                            value={timeIn} 
                            onChange={(e) => setTimeIn(e.target.value)}
                        />
                        <div className={`note ${isOutOfRange ? 'error' : ''}`}>
                            For DS4 the minimum time in is 07:30 and maximum time in is 09:30.
                        </div>
                    </div>

                    <div className="weather-widget">
                        <div className="weather-icon">{weatherInfo.icon}</div>
                        <div className="weather-info">
                            <h3>{weatherInfo.title} {weatherData && `(${weatherData.temperature}¬∞C)`}</h3>
                            <p>{weatherInfo.msg}</p>
                        </div>
                    </div>

                    {prayerTimes.length > 0 && (
                        <div className="prayer-container">
                            {prayerTimes.map((p, index) => (
                                <div key={index} className={`prayer-card ${nextPrayer === p.name ? 'active' : ''}`}>
                                    <div className="prayer-name">{p.name}</div>
                                    <div className="prayer-time">{p.time}</div>
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="result-card">
                        <h2>Standard Time Out</h2>
                        <div className="time-display">{timeOut}</div>
                        <small>(9.5 Hours Shift)</small>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Overtime</th>
                                <th>Clock Out At</th>
                            </tr>
                        </thead>
                        <tbody>
                            {otTable.map((row, index) => (
                                <tr key={index}>
                                    <td>{row.label}</td>
                                    <td>{row.time}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
