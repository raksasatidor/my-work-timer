<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Work Time Calculator</title>
    <link rel="stylesheet" href="style.css">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- TRANSLATION DICTIONARY ---
        const translations = {
            en: {
                title: "Go Home Calculator",
                timeIn: "Time In",
                standardOut: "Standard Time Out",
                halfDayOut: "Half Day / Leave Out",
                shiftHours: "(9.5 Hours Shift)",
                halfShiftHours: "(4h 45m Shift)",
                headerOT: "Overtime",
                headerClockOut: "Clock Out",
                headerRate: "Rate (RM)",
                noteError: "For DS4 the minimum time in is 07:30 and maximum time in is 09:30.",
                weatherCheck: "Checking Sony...",
                weatherStorm: "Stormy at Sony",
                weatherRain: "Raining at Sony",
                weatherClear: "Sunny at Sony",
                weatherNight: "Clear Night at Sony",
                msgStorm: "Dangerously stormy! Stay inside, you're electric enough without the lightning. ‚ö°",
                msgRain: "Don't forget your umbrella! It's crying outside, but your outfit is still fire. üî•",
                msgClear: "No umbrella needed! The weather is bright, just like your beautiful face today. ‚ú®",
                msgNight: "The stars are out! Drive safe and have a restful evening. üåô",
                prayers: {
                    fajr: "Fajr", dhuhr: "Dhuhr", asr: "Asr", maghrib: "Maghrib", isha: "Isha"
                },
                labels: ["1 Hour", "2 Hours", "3 Hours", "4 Hours"],
                achieveTitle: "RM 22.35 SECURED! üí∞",
                achieveMsg: "You've survived 1 Hour of OT! Keep grinding for the next level, or run home to your loving family? The choice is yours. ‚ù§Ô∏è",
                timeLeft: "{h}h {m}m to freedom! üöÄ",
                timeDone: "Shift Done! Go Home! üéâ"
            },
            cn: {
                title: "‰∏ãÁè≠Êó∂Èó¥ËÆ°ÁÆóÂô®",
                timeIn: "‰∏äÁè≠Êó∂Èó¥",
                standardOut: "Ê†áÂáÜ‰∏ãÁè≠Êó∂Èó¥",
                halfDayOut: "ÂçäÂ§© / ËØ∑ÂÅá‰∏ãÁè≠Êó∂Èó¥",
                shiftHours: "(9.5 Â∞èÊó∂ËΩÆÁè≠)",
                halfShiftHours: "(4Â∞èÊó∂ 45ÂàÜ ËΩÆÁè≠)",
                headerOT: "Âä†Áè≠Êó∂Èïø",
                headerClockOut: "ÊâìÂç°Êó∂Èó¥",
                headerRate: "Ê¥•Ë¥¥ (RM)",
                noteError: "DS4 ÊúÄÊó©‰∏äÁè≠Êó∂Èó¥‰∏∫ 07:30ÔºåÊúÄÊôö‰∏∫ 09:30„ÄÇ",
                weatherCheck: "Ê≠£Âú®Ê£ÄÊü• Sony Â§©Ê∞î...",
                weatherStorm: "Sony Ê≠£Âú®Êö¥È£éÈõ®",
                weatherRain: "Sony Ê≠£Âú®‰∏ãÈõ®",
                weatherClear: "Sony Èò≥ÂÖâÊòéÂ™ö",
                weatherNight: "Sony Â§úÁ©∫Êô¥Êúó",
                msgStorm: "Â§ñÈù¢È£éÊö¥ÂæàÂç±Èô©ÔºÅÂëÜÂú®ÂÆ§ÂÜÖÂêßÔºå‰∏çÁî®Èó™Áîµ‰Ω†‰πüÂ§üËø∑‰∫∫‰∫Ü„ÄÇ‚ö°",
                msgRain: "Âà´Âøò‰∫ÜÂ∏¶‰ºûÔºÅÂ§©Âú®Âì≠Ôºå‰ΩÜ‰Ω†ÁöÑÁ©øÊê≠‰æùÁÑ∂ÁÅ´Ëæ£„ÄÇüî•",
                msgClear: "‰∏çÈúÄË¶Å‰ºûÔºÅÂ§©Ê∞îÊô¥ÊúóÔºåÂ∞±ÂÉè‰Ω†‰ªäÂ§©Áæé‰∏ΩÁöÑËÑ∏Â∫û‰∏ÄÊ†∑„ÄÇ‚ú®",
                msgNight: "ÊòüÊòüÂá∫Êù•‰∫ÜÔºÅÂõûÂÆ∂Ë∑Ø‰∏äÂ∞èÂøÉÈ©æÈ©∂ÔºåÊôöÂÆâ„ÄÇüåô",
                prayers: {
                    fajr: "Êô®Á§º", dhuhr: "ÊôåÁ§º", asr: "Êô°Á§º", maghrib: "ÊòèÁ§º", isha: "ÂÆµÁ§º"
                },
                labels: ["1 Â∞èÊó∂", "2 Â∞èÊó∂", "3 Â∞èÊó∂", "4 Â∞èÊó∂"],
                achieveTitle: "RM 22.35 Âà∞ÊâãÔºÅüí∞",
                achieveMsg: "Âä†Áè≠ 1 Â∞èÊó∂ËææÊàêÔºÅÁªßÁª≠Â•ãÊñóËµö‰∏ã‰∏ÄÊ°∂ÈáëÔºåËøòÊòØÂõûÂÆ∂Èô™‰∫≤Áà±ÁöÑÂÆ∂‰∫∫ÔºüÁî±‰Ω†ÂÜ≥ÂÆö„ÄÇ‚ù§Ô∏è",
                timeLeft: "Ë∑ùÁ¶ª‰∏ãÁè≠ËøòÊúâ {h}Â∞èÊó∂ {m}ÂàÜ! üöÄ",
                timeDone: "‰∏ãÁè≠Âï¶ÔºÅÂø´ÂõûÂÆ∂ÔºÅüéâ"
            },
            jp: {
                title: "ÈÄÄÂã§ÊôÇÈñìË®àÁÆóÊ©ü",
                timeIn: "Âá∫Âã§ÊôÇÈñì",
                standardOut: "ÂÆöÊôÇÈÄÄÁ§æÊôÇÈñì",
                halfDayOut: "Âçä‰ºë / Êó©ÈÄÄÊôÇÈñì",
                shiftHours: "(9.5ÊôÇÈñì„Ç∑„Éï„Éà)",
                halfShiftHours: "(4ÊôÇÈñì45ÂàÜ „Ç∑„Éï„Éà)",
                headerOT: "ÊÆãÊ•≠",
                headerClockOut: "ÈÄÄÂã§ÊôÇÂàª",
                headerRate: "ÊâãÂΩì (RM)",
                noteError: "DS4„ÅÆÂá∫Âã§ÊôÇÈñì„ÅØ07:30„Åã„Çâ09:30„ÅÆÈñì„Åß„Åô„ÄÇ",
                weatherCheck: "Sony„ÅÆÂ§©Ê∞ó„ÇíÁ¢∫Ë™ç‰∏≠...",
                weatherStorm: "Sony„ÅØÂµê„Åß„Åô",
                weatherRain: "Sony„ÅØÈõ®„Åß„Åô",
                weatherClear: "Sony„ÅØÊô¥„Çå„Åß„Åô",
                weatherNight: "Sony„ÅØÊô¥„Çå„ÅüÂ§ú„Åß„Åô",
                msgStorm: "Âç±Èô∫„Å™Âµê„Åß„ÅôÔºÅÂÆ§ÂÜÖ„Å´„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÈõ∑„Åå„Å™„Åè„Å¶„ÇÇ„ÅÇ„Å™„Åü„ÅØÂçÅÂàÜÂà∫ÊøÄÁöÑ„Åß„Åô„Åã„Çâ„ÄÇ‚ö°",
                msgRain: "ÂÇò„ÇíÂøò„Çå„Å™„ÅÑ„ÅßÔºÅÁ©∫„ÅØÊ≥£„ÅÑ„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊúç„ÅØÊ±∫„Åæ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇüî•",
                msgClear: "ÂÇò„ÅØ„ÅÑ„Çä„Åæ„Åõ„ÇìÔºÅÂ§©Ê∞ó„ÅØÊô¥„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÅ‰ªäÊó•„ÅÆ„ÅÇ„Å™„Åü„ÅÆÁæé„Åó„ÅÑÈ°î„ÅÆ„Çà„ÅÜ„Å´„ÄÇ‚ú®",
                msgNight: "Êòü„ÅåÂá∫„Å¶„ÅÑ„Åæ„ÅôÔºÅÊ∞ó„Çí„Å§„Åë„Å¶Â∏∞„Å£„Å¶„Åè„Å†„Åï„ÅÑ„Å≠„ÄÇ„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ„ÄÇüåô",
                prayers: {
                    fajr: "„Éï„Ç°„Ç∏„É•„É´", dhuhr: "„Ç∫„Éï„É´", asr: "„Ç¢„Çπ„É´", maghrib: "„Éû„Ç∞„É™„Éñ", isha: "„Ç§„Ç∑„É£"
                },
                labels: ["1ÊôÇÈñì", "2ÊôÇÈñì", "3ÊôÇÈñì", "4ÊôÇÈñì"],
                achieveTitle: "RM 22.35 „Ç≤„ÉÉ„ÉàÔºÅüí∞",
                achieveMsg: "ÊÆãÊ•≠1ÊôÇÈñìÈÅîÊàêÔºÅÊ¨°„ÅÆ„É¨„Éô„É´„ÇíÁõÆÊåá„Åó„Å¶È†ëÂºµ„Çã„Åã„ÄÅÊÑõ„Åô„ÇãÂÆ∂Êóè„ÅÆÂÖÉ„Å∏Â∏∞„Çã„ÅãÔºüÊ±∫„ÇÅ„Çã„ÅÆ„ÅØ„ÅÇ„Å™„Åü„Åß„Åô„ÄÇ‚ù§Ô∏è",
                timeLeft: "Ëá™Áî±„Åæ„Åß„ÅÇ„Å® {h}ÊôÇÈñì {m}ÂàÜ! üöÄ",
                timeDone: "„ÅäÁñ≤„ÇåÊßòÔºÅÂ∏∞„Çç„ÅÜÔºÅüéâ"
            }
        };

        function App() {
            // --- STATE MANAGEMENT ---
            const [timeIn, setTimeIn] = useState("08:30");
            const [timeOut, setTimeOut] = useState("");
            const [halfDayOut, setHalfDayOut] = useState(""); // NEW State for Half Day
            const [otTable, setOtTable] = useState([]);
            const [isOutOfRange, setIsOutOfRange] = useState(false);
            const [theme, setTheme] = useState('light');
            const [lang, setLang] = useState('en'); 
            
            const [currentDate, setCurrentDate] = useState(new Date());
            const [weatherData, setWeatherData] = useState(null);
            const [prayerTimes, setPrayerTimes] = useState([]);
            const [nextPrayer, setNextPrayer] = useState(null);
            
            const [showAchievement, setShowAchievement] = useState(false);
            
            // Countdown States
            const [countdownMsg, setCountdownMsg] = useState("");
            const [halfDayCountdownMsg, setHalfDayCountdownMsg] = useState(""); // NEW

            const t = translations[lang];

            const SWAT_RATE_PER_HOUR = 22.35;

            // --- SETUP & INIT ---
            useEffect(() => {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const initialTheme = prefersDark ? 'dark' : 'light';
                setTheme(initialTheme);
                document.documentElement.setAttribute('data-theme', initialTheme);
                
                fetchWeather();
                fetchPrayerTimes();

                const timer = setInterval(() => {
                    const now = new Date();
                    setCurrentDate(now);
                }, 1000);
                
                return () => clearInterval(timer);
            }, []);

            const toggleTheme = () => {
                const newTheme = theme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
                document.documentElement.setAttribute('data-theme', newTheme);
            };

            const setLanguage = (newLang) => setLang(newLang);

            // --- DATE FORMATTER ---
            const formatDate = (date) => {
                let locale = 'en-GB';
                if (lang === 'cn') locale = 'zh-CN';
                if (lang === 'jp') locale = 'ja-JP';

                return date.toLocaleDateString(locale, { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            };

            // --- WEATHER ---
            const fetchWeather = async () => {
                try {
                    const response = await fetch("https://api.open-meteo.com/v1/forecast?latitude=2.937019&longitude=101.760007&current_weather=true");
                    const data = await response.json();
                    setWeatherData(data.current_weather);
                } catch (error) { console.error("Weather fail", error); }
            };

            const getWeatherMessage = (data) => {
                if (!data) return { icon: "‚ùì", title: t.weatherCheck, msg: "..." };
                
                const code = data.weathercode;
                const isDay = data.is_day; 

                if (code >= 95) return { icon: "‚õàÔ∏è", title: t.weatherStorm, msg: t.msgStorm };
                if (code >= 51) return { icon: "‚òî", title: t.weatherRain, msg: t.msgRain };
                
                if (isDay === 0) {
                    return { icon: "üåô", title: t.weatherNight, msg: t.msgNight };
                } else {
                    return { icon: "‚òÄÔ∏è", title: t.weatherClear, msg: t.msgClear };
                }
            };

            // --- PRAYERS ---
            const fetchPrayerTimes = async () => {
                try {
                    const res = await fetch("https://api.waktusolat.app/v2/solat/SGR01");
                    const data = await res.json();
                    const today = new Date();
                    const day = today.getDate();
                    const todayPrayers = data.prayers[day - 1]; 

                    if (todayPrayers) {
                        const formatTime = (timestamp) => {
                            const date = new Date(timestamp * 1000);
                            let hours = date.getHours();
                            let minutes = date.getMinutes();
                            const ampm = hours >= 12 ? 'PM' : 'AM';
                            hours = hours % 12;
                            hours = hours ? hours : 12;
                            minutes = minutes < 10 ? '0' + minutes : minutes;
                            return `${hours}:${minutes} ${ampm}`;
                        };
                        const list = [
                            { key: 'fajr', time: formatTime(todayPrayers.fajr), raw: todayPrayers.fajr },
                            { key: 'dhuhr', time: formatTime(todayPrayers.dhuhr), raw: todayPrayers.dhuhr },
                            { key: 'asr', time: formatTime(todayPrayers.asr), raw: todayPrayers.asr },
                            { key: 'maghrib', time: formatTime(todayPrayers.maghrib), raw: todayPrayers.maghrib },
                            { key: 'isha', time: formatTime(todayPrayers.isha), raw: todayPrayers.isha }
                        ];
                        setPrayerTimes(list);
                        determineNextPrayer(list);
                    }
                } catch (error) { console.error("Prayer fail", error); }
            };

            const determineNextPrayer = (prayers) => {
                const now = Math.floor(Date.now() / 1000);
                const next = prayers.find(p => p.raw > now);
                if (next) setNextPrayer(next.key);
                else setNextPrayer(null); 
            };

            // --- CALCULATIONS ---
            const addTime = (baseTime, hoursToAdd, minutesToAdd) => {
                if (!baseTime) return "";
                const [h, m] = baseTime.split(':').map(Number);
                const date = new Date();
                date.setHours(h);
                date.setMinutes(m);
                date.setHours(date.getHours() + hoursToAdd);
                date.setMinutes(date.getMinutes() + minutesToAdd);
                const newH = String(date.getHours()).padStart(2, '0');
                const newM = String(date.getMinutes()).padStart(2, '0');
                return `${newH}:${newM}`;
            };

            const getTimeObject = (timeStr) => {
                if (!timeStr) return null;
                const [h, m] = timeStr.split(':').map(Number);
                const d = new Date();
                d.setHours(h, m, 0, 0);
                return d;
            };

            // Calculate Countdowns Logic
            useEffect(() => {
                const now = currentDate;

                // Helper to update text
                const updateTimer = (targetTimeStr, setMsgFunc) => {
                    if (!targetTimeStr) {
                        setMsgFunc("");
                        return;
                    }
                    const targetDate = getTimeObject(targetTimeStr);
                    if (!targetDate) return;

                    const diff = targetDate - now;
                    if (diff <= 0) {
                        setMsgFunc(t.timeDone);
                    } else {
                        const diffHrs = Math.floor(diff / 3600000);
                        const diffMins = Math.floor((diff % 3600000) / 60000);
                        const msg = t.timeLeft
                            .replace('{h}', diffHrs)
                            .replace('{m}', diffMins);
                        setMsgFunc(msg);
                    }
                };

                // Update Standard Timer
                updateTimer(timeOut, setCountdownMsg);
                
                // Update Half Day Timer
                updateTimer(halfDayOut, setHalfDayCountdownMsg);

            }, [currentDate, timeOut, halfDayOut, lang]);

            useEffect(() => {
                if (timeIn) {
                    if (timeIn < "07:30" || timeIn > "09:30") setIsOutOfRange(true);
                    else setIsOutOfRange(false);

                    // Standard Shift (9h 30m)
                    const standardExit = addTime(timeIn, 9, 30);
                    setTimeOut(standardExit);

                    // Half Day Shift (4h 45m)
                    const halfExit = addTime(timeIn, 4, 45);
                    setHalfDayOut(halfExit);

                    const ot1 = addTime(standardExit, 1, 10);
                    const ot2 = addTime(ot1, 1, 0);
                    const ot3 = addTime(ot2, 1, 0);
                    const ot4 = addTime(ot3, 1, 0);

                    // Achievement Logic
                    const now = new Date();
                    const ot1Date = getTimeObject(ot1);
                    if (ot1Date && now >= ot1Date) setShowAchievement(true);
                    else setShowAchievement(false);

                    const rate1 = (SWAT_RATE_PER_HOUR * 1).toFixed(2);
                    const rate2 = (SWAT_RATE_PER_HOUR * 2).toFixed(2);
                    const rate3 = (SWAT_RATE_PER_HOUR * 3).toFixed(2);
                    const rate4 = (SWAT_RATE_PER_HOUR * 4).toFixed(2);

                    setOtTable([
                        { label: t.labels[0], time: ot1, rate: rate1 },
                        { label: t.labels[1], time: ot2, rate: rate2 },
                        { label: t.labels[2], time: ot3, rate: rate3 },
                        { label: t.labels[3], time: ot4, rate: rate4 },
                    ]);
                }
            }, [timeIn, lang, currentDate]);

            const weatherInfo = getWeatherMessage(weatherData);

            return (
                <div className="container">
                    <div className="top-controls">
                        <div className="lang-switcher">
                            <button className={`lang-btn ${lang === 'en' ? 'active' : ''}`} onClick={() => setLanguage('en')}>EN</button>
                            <button className={`lang-btn ${lang === 'cn' ? 'active' : ''}`} onClick={() => setLanguage('cn')}>CN</button>
                            <button className={`lang-btn ${lang === 'jp' ? 'active' : ''}`} onClick={() => setLanguage('jp')}>JP</button>
                        </div>
                        <button className="theme-toggle" onClick={toggleTheme}>
                            {theme === 'light' ? 'üåô' : '‚òÄÔ∏è'}
                        </button>
                    </div>

                    <h1>{t.title}</h1>
                    
                    <div className="live-date">{formatDate(currentDate)}</div>

                    {showAchievement && (
                        <div className="achievement-banner">
                            <div className="achievement-title">{t.achieveTitle}</div>
                            <div className="achievement-msg">{t.achieveMsg}</div>
                        </div>
                    )}

                    <div className="input-group">
                        <label>{t.timeIn}</label>
                        <input 
                            type="time" 
                            value={timeIn} 
                            onChange={(e) => setTimeIn(e.target.value)}
                        />
                        <div className={`note ${isOutOfRange ? 'error' : ''}`}>
                            {t.noteError}
                        </div>
                    </div>

                    {/* STANDARD TIME OUT CARD */}
                    <div className="result-card">
                        <h2>{t.standardOut}</h2>
                        <div className="time-display">{timeOut}</div>
                        <div className="countdown">{countdownMsg}</div>
                        <small style={{marginTop: '10px'}}>{t.shiftHours}</small>
                    </div>

                    {/* NEW: HALF DAY CARD */}
                    <div className="half-day-card">
                        <h2>{t.halfDayOut}</h2>
                        <div className="time-display">{halfDayOut}</div>
                        <div className="countdown">{halfDayCountdownMsg}</div>
                        <small>{t.halfShiftHours}</small>
                    </div>

                    <div className="weather-widget">
                        <div className="weather-icon">{weatherInfo.icon}</div>
                        <div className="weather-info">
                            <h3>{weatherInfo.title} {weatherData && `(${weatherData.temperature}¬∞C)`}</h3>
                            <p>{weatherInfo.msg}</p>
                        </div>
                    </div>

                    {prayerTimes.length > 0 && (
                        <div className="prayer-container">
                            {prayerTimes.map((p, index) => (
                                <div key={index} className={`prayer-card ${nextPrayer === p.key ? 'active' : ''}`}>
                                    <div className="prayer-name">{t.prayers[p.key]}</div>
                                    <div className="prayer-time">{p.time}</div>
                                </div>
                            ))}
                        </div>
                    )}

                    <table>
                        <thead>
                            <tr>
                                <th>{t.headerOT}</th>
                                <th>{t.headerClockOut}</th>
                                <th>{t.headerRate}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {otTable.map((row, index) => (
                                <tr key={index}>
                                    <td>{row.label}</td>
                                    <td>{row.time}</td>
                                    <td style={{fontWeight: 'bold', color: theme === 'light' ? '#2e7d32' : '#4caf50'}}>
                                        {row.rate}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
